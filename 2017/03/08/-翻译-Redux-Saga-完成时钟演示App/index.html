<!DOCTYPE html>
<html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init">
<head>
  <meta charset="utf-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <link rel="icon" href="/favicon.ico">
  
  <title>phpsmarter | 翻译-Redux-Saga-完成时钟演示App</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/lib/fancybox/jquery.fancybox-1.3.4.css">
  <!--在这里倒入jquery 方便处理部分页面的jquery-->
  <script src="https://cdn.staticfile.org/jquery/1.7/jquery.min.js" type="text/javascript" ></script>
</head>

<body>
	<header class="site-header navfixed-false">
  <div class="container">
      <h1><a href="/" title="phpsmarter"><span class="octicon octicon-mark-github"></span> phpsmarter</a></h1>
      <nav class="site-header-nav" role="navigation">
        
              
              <a href="/"  class=" site-header-nav-item hvr-underline-from-center" title="首页">首页</a>
        
              
              <a href="/categories/"  class=" site-header-nav-item hvr-underline-from-center" title="分类">分类</a>
        
              
              <a href="/open-source/"  class=" site-header-nav-item hvr-underline-from-center" title="开源项目">开源项目</a>
        
              
              <a href="/message/"  class=" site-header-nav-item hvr-underline-from-center" title="留言板">留言板</a>
        
              
              <a href="/javascript/"  class=" site-header-nav-item hvr-underline-from-center" title="javascript">javascript</a>
        
      </nav>
  </div>
</header>

	
<section class="collection-head geopattern" data-pattern-id="翻译-Redux-Saga-完成时钟演示App" >
    <div class="container">
        <div class="collection-title">
            <h1 class="collection-header">
                翻译-Redux-Saga-完成时钟演示App
            </h1>
            
                <div class="collection-info">
                    <span class="meta-info">
                        <span class="octicon octicon-calendar"></span>
                        <time datetime="2017-03-08T00:04:10.000Z" itemprop="datePublished">2017-03-08</time>
                    </span>
                    
                        <span class="meta-info">
                            <span class="octicon octicon-file-directory"></span>
                            <a href='/categories/翻译/' title=''>翻译</a>
                        </span>
                    
                </div>
            
        </div>
    </div>
</section>
	<section class="container">
    <div class="columns">
        <div class="column three-fourths" >
            <article class="article-content markdown-body">
                <blockquote>
<p>翻译版本，<a href="http://ohyayanotherblog.ghost.io/redux-saga-finishing-the-clock-demo-app/" target="_blank" rel="external">原文请见</a><br><em>14 NOVEMBER 2016</em></p>
</blockquote>
<h2 id="实现Saga代码"><a href="#实现Saga代码" class="headerlink" title="实现Saga代码"></a>实现Saga代码</h2><p>这篇文章是三篇关于Redux Saga系列文章的第三篇,也是最后一篇.在第一部分我们先对有关的概念进行了热身.在第二部分,我们和Redux关系推进到了另一个高度.我们把Saga付诸实施.在最后一篇文章,我们把最后一部分内容写完.如果你没有克隆app repo，可以在这个<a href="https://github.com/granmoe/redux-saga-clock-tutorial" target="_blank" rel="external">地址克隆</a>,如果不想看这个repo,想直接跳到最终的app代码,可以<a href="https://github.com/granmoe/redux-saga-clock.git" target="_blank" rel="external">看这个repo</a>.   <a href="https://granmoe.github.io/redux-saga-clock/" target="_blank" rel="external">live demo看这里</a>.</p>
<hr>
<p><a href="http://www.jianshu.com/p/6f8678a6ad78" target="_blank" rel="external">第一部分译文请见</a>，<br><a href="http://www.jianshu.com/p/fad0136e77c0" target="_blank" rel="external">第二部分译文请见</a>，<br><a href="http://www.jianshu.com/p/88fc4236b505" target="_blank" rel="external">第三部分译文请见</a>.</p>
<hr>
<h2 id="What’s-my-name-agian"><a href="#What’s-my-name-agian" class="headerlink" title="What’s my name agian?"></a>What’s my name agian?</h2><p>在上一篇文章中,我们设计了基础但是有点幼稚的需求,创建了很初级时钟,可以对用户的交互操作做出一些响应.(译者：后面有几句似乎和技术没有太大关系,我就没有翻译了.请参见原文).</p>
<p>我们决定只使用最小化的redux state值有一个字段“milliseconds”来代表时钟的时间.因为我们的时钟需要向前,向后,重置,所以创建了相应的redux action去执行增,减,重置actions,这些actions可以改变state.<br>当我们进入某些saga code代码,创建一个saga监听三个actions(开始,暂停,回拨),只有收到相应action的时候,输出日志内容.最后,我们的目标是把日志输出替换成时钟实际运行的流程,例如每一秒种发送一个递减的action,因此app state的异步操作需要好好的设计.最后我们创建一个简单的React组件,可以让我们根据期望的saga代码的工作流程测试redux和saga action,观察state的更新.</p>
<p>现在我们来完成这件事,我们想给朋友留下深刻的印象,看上去有意思一点,所以会使用一些非常酷的SVG技术,当时间增加的时候,时钟可以画出一些图形.但是最重要的是使用Saga可以是app唱歌,跳舞.开始编码.</p>
<p>##实现Saga<br>我们的duck.js是非常小的,实际上仅仅需要很少几行代码去完成saga/redux.目前为止我们的duck代码是这样的:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">export</span> <span class="function"><span class="keyword">function</span>* <span class="title">rootSaga</span> (<span class="params"></span>) </span>&#123;  </div><div class="line">  <span class="keyword">yield</span> takeLatest([<span class="string">'start-clock'</span>, <span class="string">'pause-clock'</span>, <span class="string">'rewind-clock'</span>], handleClockAction)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span>* <span class="title">handleClockAction</span> (<span class="params">&#123; type &#125;</span>) </span>&#123;  </div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Pushed this action to handleClockAction: '</span>, type)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<hr>
<p>正如我们上一篇文章所讨论的,<code>takeLatest</code>将会监听action type数组中的任何一个action type,当每次发送的action和action type之一匹配的时候,会运行另一个流程(在我们的app中,是<code>handleClockAction</code>).<code>takeLatest</code>也会取消之前的运行流程,他也会传递整个action对象,我们可以在<code>handleClockAction</code>使用这个对象.</p>
<p>现在让我们考虑一下整个app应该怎么工作.所有的实际流程都是在<code>handelClockAction</code>中,在三个saga actions中,每一个action我们都做一些不同的工作.深入到代码的基础构架中.使用<code>if/else if</code>代码块替换<code>handleClockAction</code>的单行代码.这个代码块为每个action type提供分支判断逻辑,并且输出一些文本日志,验证代码的正确性.</p>
<p>给你几秒钟,耐心等待一下.</p>
<p>好了,下面的是我的<code>handelClockAction</code>的实际样子:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//if else if代码块进行分支判断执行流程</span></div><div class="line"><span class="function"><span class="keyword">function</span>* <span class="title">handleClockAction</span> (<span class="params">&#123; type &#125;</span>) </span>&#123;  </div><div class="line">  <span class="keyword">if</span> (type === <span class="string">'start-clock'</span>) &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">`Received <span class="subst">$&#123;type&#125;</span>. We need to run the clock forward here.`</span>)</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">'rewind-clock'</span>) &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">`Received <span class="subst">$&#123;type&#125;</span>. We need to run the clock backwards here.`</span>)</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">'pause-clock'</span>) &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">`Received <span class="subst">$&#123;type&#125;</span>. Guess what needs to be done here?`</span>)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>现在运行app(npm start),转到localhost:8080,打开javascript终端,测试一些saga actions(他们和SVG图下面的按钮是连接在一起的).我们可以看到每次action执行时,有相应的日志输出.</p>
<p>当我们开始clock action,我们想让时钟每100毫秒递增一次.为了这样做,从saga导入助手函数”delay”.编辑redux-saga文件.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; delay, takeLatest &#125; <span class="keyword">from</span> <span class="string">'redux-saga'</span></div></pre></td></tr></table></figure>
<hr>
<p>delay非常简单，功能不言自明.它接收一个参数,毫秒数,然后暂停执行对应的时间.例如<code>yield delay(50)</code>.在<code>if/else if</code>代码块中添加一些逻辑代码,每1000ms,输出日志.请记住,你需要这个过程无限制的重复.我们可以使用非常简单的原生javascript代码控制流来实现.我想让你先猜猜怎么实现.</p>
<p>不要偷看.</p>
<p>花点时间考虑一下.</p>
<p>好了,下面是我的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">function</span>* <span class="title">handleClockAction</span> (<span class="params">&#123; type &#125;</span>) </span>&#123;  </div><div class="line">  <span class="keyword">if</span> (type === <span class="string">'start-clock'</span>) &#123;</div><div class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;<span class="comment">//就是这个while(true)语句保持始终运行</span></div><div class="line">      <span class="keyword">yield</span> delay(<span class="number">1000</span>)</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">`Received <span class="subst">$&#123;type&#125;</span>. We need to run the clock forward here.`</span>)</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">'rewind-clock'</span>) &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">`Received <span class="subst">$&#123;type&#125;</span>. We need to run the clock backwards here.`</span>)</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">'pause-clock'</span>) &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">`Received <span class="subst">$&#123;type&#125;</span>. Guess what needs to be done here?`</span>)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>在这一点上,打开js终端,查看日志输出,可以得到直观的信息.你将看到,start clock action暂停100毫秒,然后输出一些日志信息,之后无限地重复这个过程.注意一个关键事实,无论什么时间我们的<code>takeLatest</code>函数接收到匹配的action的时候,它会退出当前运行的<code>handleClockAction</code>.如果是暂停的action,什么事情也不做,但是还是要退出当前任何的action,猜猜我们应该怎么做？删除一点代码！暂停的时钟将会自动开始工作,因为<code>takeLatest</code>会退出当前的<code>handleClockAction</code>,不管时钟是向前还是向后运行,时钟都会停止.<br>确信你理解<code>takeLatest</code>的关键特性.在<code>handleClockAction</code>中做出合适的改变.应该想下面这样做:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">function</span>* <span class="title">handleClockAction</span> (<span class="params">&#123; type &#125;</span>) </span>&#123;  </div><div class="line">  <span class="keyword">if</span> (type === <span class="string">'start-clock'</span>) &#123;</div><div class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</div><div class="line">      <span class="keyword">yield</span> delay(<span class="number">1000</span>)</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">`Received <span class="subst">$&#123;type&#125;</span>. We need to run the clock forward here.`</span>)</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">'rewind-clock'</span>) &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">`Received <span class="subst">$&#123;type&#125;</span>. We need to run the clock backwards here.`</span>)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>现在让我们在循环内真正的dispatch一个action.<br>（旁白：我们没有实际dispatch一个action，仅仅请求中间件来做这件事,暂时不要担心,我后面会解释清楚的.)</p>
<p>在Saga里面dispatch一个action,我们要使用<code>put</code> side effects,添加一行代码到duck文件里.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; put &#125; <span class="keyword">from</span> <span class="string">'redux-saga/effects'</span></div></pre></td></tr></table></figure>
<hr>
<p>通过<code>put</code>请求一个dispatch的action,简单的使用<code>yield put({ type: &#39;hi&#39;, data: &#39;I am an action&#39; })</code>就可以了.意思是在<code>put</code>里,可以调用一个action creator 返回一个单纯对象,像这样<code>yield put(someAction())</code>.(在javascript中函数的参数会立即求值).还记得我们在开始创建的那些redux action吗？我们要使用一个,转到while循环,试试<code>put</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">  <span class="function"><span class="keyword">function</span>* <span class="title">handleClockAction</span> (<span class="params">&#123; type &#125;</span>) </span>&#123;  </div><div class="line">  <span class="keyword">if</span> (type === <span class="string">'start-clock'</span>) &#123;</div><div class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</div><div class="line">      <span class="keyword">yield</span> delay(<span class="number">1000</span>)</div><div class="line">      <span class="keyword">yield</span> put(incrementMilliseconds())<span class="comment">//注意这一句</span></div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">'rewind-clock'</span>) &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">`Received <span class="subst">$&#123;type&#125;</span>. We need to run the clock backwards here.`</span>)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>在你的浏览器里试试.注意在SVG下面的时钟时间是递增的.</p>
<p>为了让时钟后退,可以重用start 时钟的大部分代码.</p>
<p>下面是回退的代码:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">  <span class="function"><span class="keyword">function</span>* <span class="title">handleClockAction</span> (<span class="params">&#123; type &#125;</span>) </span>&#123;  </div><div class="line">  <span class="keyword">if</span> (type === <span class="string">'start-clock'</span>) &#123;</div><div class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</div><div class="line">      <span class="keyword">yield</span> delay(<span class="number">1000</span>)</div><div class="line">      <span class="keyword">yield</span> put(incrementMilliseconds())</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">'rewind-clock'</span>) &#123;</div><div class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</div><div class="line">      <span class="keyword">yield</span> delay(<span class="number">1000</span>)</div><div class="line">      <span class="keyword">yield</span> put(decrementMilliseconds())<span class="comment">//递减</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<hr>
<p>现在测试一下所有的saga actions,确保每件事情都工作正常.如果工作不正常,那绝对是你的错,不是我的错.开个玩笑.(译者:后面几句没有翻译)</p>
<p>激动人心的时刻是运行saga代码并且通过实验学到的了一些东西.一个提示：<code>delay</code>是阻塞的,其他的effect语句都是非阻塞的.试着使用<code>for</code>循环.要么把<code>while</code>条件改为false.我们已经放弃了promise的世界,现在我们可以使用这些简单的,可预测的,原生的javascript来表现出所有的控制流语句.</p>
<p>好了,把saga代码恢复到上面的样子.</p>
<p>做好了上面的恢复,我的saga代码已经完成,可以操作了(注意事项：在最终版本上,我已经把代码重新组织了一下,以便于阅读).</p>
<h2 id="Saga’s的方式处理异步操作"><a href="#Saga’s的方式处理异步操作" class="headerlink" title="Saga’s的方式处理异步操作"></a>Saga’s的方式处理异步操作</h2><p>好了.现在让我们再做一些事情,让我们谈谈代码是怎么工作的.Redux Saga中核心的概念是:我们实际没有像dispatch一个action到store一样执行异步操作.替代方法是:我们yield异步操作到saga middleware,然后middleware执行他们.简单的说,我们给Saga一个指示,告诉他我们希望发生什么.这些异步操作描述是遵循标准generator输出的单纯对象:<code>{value:any,done:boolean}</code>,这和我们在第一部分看到的完全一样.<br>例如,<code>yield put</code>发送一个对象到中间件,这个中间件包含一个action对象,可以dispatch一些内容给我们(译者:这个地方有点绕,其实是在异步操作完成以后,需要再次dispatch返回的结果,从而改变state，这样我们的组件才可以根据state的改变来渲染效果,例如从远程资源请求数据,通常都需要把整个操作分成几步来完成,每一步要改变不同的state,在dispatch中再dispatch)这样定义异步数据流有很多好处,其中之一是可测试性.我们可以很简单的在每一个side effect返回中间件的时候创建断言(继续关注后续的内容,有测试的深入介绍)</p>
<p> 我们应该遵循redux-saga的最佳实践,做些小小的更新,从redux-saga/effects中导入<code>call</code>,把<code>yield delay(100)</code>改为<code>yield call(delay,100)</code>.因为我们只想返回side-effects到saga中间件,saga提供了<code>call</code>effect把non-effects转变为effects.与仅仅yield<code>delay</code>自己(promise对象)不同,我们通过<code>call</code>把<code>delay</code>转变为effect,然后yield它.所有的non-effect都应该做相同的处理.<code>call</code>的语法调用一个函数,并且传递参数列表.例如:<code>yield call(fetch,url,options)</code>.最后,注意,<code>call</code>可以被promise对象,generators,或者函数使用.</p>
<h2 id="代码不要太丑陋"><a href="#代码不要太丑陋" class="headerlink" title="代码不要太丑陋"></a>代码不要太丑陋</h2><p> 我们需要创建一个文件作为app的配置,包含一些常量.为什么不叫做“config.js”在/src目录下创建,粘贴下面的内容.</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">  <span class="keyword">const</span> MAX_RADIUS = <span class="number">40</span></div><div class="line"></div><div class="line"><span class="keyword">let</span> hands = [  </div><div class="line">  &#123; <span class="attr">ms</span>: <span class="number">144000</span>, <span class="attr">maxTicks</span>: <span class="number">1</span> &#125;,</div><div class="line">  &#123; <span class="attr">ms</span>: <span class="number">36000</span>, <span class="attr">maxTicks</span>: <span class="number">4</span> &#125;,</div><div class="line">  &#123; <span class="attr">ms</span>: <span class="number">12000</span>, <span class="attr">maxTicks</span>: <span class="number">3</span> &#125;,</div><div class="line">  &#123; <span class="attr">ms</span>: <span class="number">2000</span>, <span class="attr">maxTicks</span>: <span class="number">6</span> &#125;,</div><div class="line">  &#123; <span class="attr">ms</span>: <span class="number">400</span>, <span class="attr">maxTicks</span>: <span class="number">5</span> &#125;,</div><div class="line">  &#123; <span class="attr">ms</span>: <span class="number">100</span>, <span class="attr">maxTicks</span>: <span class="number">4</span> &#125;</div><div class="line">]</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> STROKE_WIDTH = MAX_RADIUS / hands.length</div><div class="line"></div><div class="line">hands = hands.map(<span class="function">(<span class="params">hand, idx</span>) =&gt;</span> &#123;  </div><div class="line">  <span class="keyword">const</span> radius = STROKE_WIDTH * (hands.length - idx)</div><div class="line"></div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    ...hand,</div><div class="line">    radius,</div><div class="line">    <span class="attr">circumference</span>: <span class="number">2</span> * <span class="built_in">Math</span>.PI * radius,</div><div class="line">    <span class="attr">alpha</span>: <span class="number">1</span> - idx / hands.length</div><div class="line">  &#125;</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> CLOCK_HANDS = hands</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> MINIMUM_MS = <span class="number">100</span></div></pre></td></tr></table></figure>
<hr>
<p> 这里面都有什么内容？让我解释一下,它是一组常量和计算量,描述SVG的外观.<br> 我不会详细讲这个内容,不是这里的重点.</p>
<p> 好了,现在我们的saga代码已经就绪,我们也定义了所有SVG需要的配置文件.再更新一下SVG内容,好完成app.jsx的代码.</p>
<h2 id="完成-HIM"><a href="#完成-HIM" class="headerlink" title="完成 HIM"></a>完成 HIM</h2><p> 下面是目前的app.jsx代码<br> <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">  <span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>  </div><div class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> &#123; incrementMilliseconds, decrementMilliseconds, resetClock, startClock, pauseClock, rewindClock &#125; <span class="keyword">from</span> <span class="string">'duck'</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Clock</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;  </div><div class="line">  render () &#123;</div><div class="line">    <span class="keyword">const</span> &#123;</div><div class="line">      milliseconds,</div><div class="line">      incrementMilliseconds,</div><div class="line">      decrementMilliseconds,</div><div class="line">      resetClock,</div><div class="line">      startClock,</div><div class="line">      pauseClock,</div><div class="line">      rewindClock</div><div class="line">    &#125; = <span class="keyword">this</span>.props</div><div class="line"></div><div class="line">    <span class="keyword">return</span> (</div><div class="line">      &lt;div&gt;</div><div class="line">        &lt;svg onClick=&#123; incrementMilliseconds &#125; onDoubleClick=&#123; resetClock &#125; onMouseLeave=&#123; decrementMilliseconds &#125;</div><div class="line">          className="clock" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="500"&gt;</div><div class="line">          &lt;circle cx="50" cy="50" r=&#123; 30 &#125; stroke=&#123; 'rgba(1,1,1,1)' &#125; fill="orange" /&gt;</div><div class="line">        &lt;/svg&gt;</div><div class="line">        &lt;p&gt;&#123; milliseconds &#125;&lt;/p&gt;</div><div class="line">        &lt;p&gt;</div><div class="line">          &lt;button type="button" onClick=&#123; startClock &#125;&gt;Start Clock&lt;/button&gt;</div><div class="line">          &lt;button type="button" onClick=&#123; pauseClock &#125;&gt;Pause Clock&lt;/button&gt;</div><div class="line">          &lt;button type="button" onClick=&#123; rewindClock &#125;&gt;Rewind Clock&lt;/button&gt;</div><div class="line">        &lt;/p&gt;</div><div class="line">      &lt;/div&gt;</div><div class="line">    )</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">export default connect(state =&gt; (&#123;  </div><div class="line">  milliseconds: state.milliseconds</div><div class="line">&#125;), (&#123;</div><div class="line">  incrementMilliseconds,</div><div class="line">  decrementMilliseconds,</div><div class="line">  resetClock,</div><div class="line">  startClock,</div><div class="line">  pauseClock,</div><div class="line">  rewindClock</div><div class="line">&#125;))(Clock)</div></pre></td></tr></table></figure></p>
<hr>
<p> 我们需要导入conifg内容,通过props传递到组件.删除一些不必要的导入文件.不再直接调用特定的actions,因为我们仅仅在saga中发出action.更新一下代码.<br> <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">  <span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>  </div><div class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> &#123; startClock, rewindClock, pauseClock, resetClock &#125; <span class="keyword">from</span> <span class="string">'duck'</span>  </div><div class="line"><span class="keyword">import</span> &#123; CLOCK_HANDS, STROKE_WIDTH &#125; <span class="keyword">from</span> <span class="string">'config'</span></div></pre></td></tr></table></figure></p>
<hr>
<p> 现在我们有了数据,可以在SVG内画出漂亮的圆环.简单点的说我们使用同心圆代表小时/分钟/秒.时间流逝的时候,改变每一个圆环的长度.为了做SVG图片,使用了一些小技巧<a href="https://css-tricks.com/svg-line-animation-works/" target="_blank" rel="external">CSS Trick blog post</a></p>
<p> 我们不再通过props手段传递millseconds字段.每次更新milliseconds时,我们计算每一个时钟指针的位置.这像是烦人的数学计算.基本上我们遍历每一个指针,然后在下一个指针重复同样的过程,(时针就减掉小时的整倍好秒数,分钟和秒一样处理),把剩余的时间传递给下去.最小的指针对应的最小的精度单位,100ms(config.js中的MAXIMUM_MS),更新你的<code>connect</code></p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">  <span class="keyword">export</span> <span class="keyword">default</span> connect(<span class="function"><span class="params">state</span> =&gt;</span> &#123;  </div><div class="line">  <span class="keyword">const</span> currentTime = state.milliseconds</div><div class="line">  <span class="keyword">let</span> remainingTime = currentTime</div><div class="line"></div><div class="line">  <span class="keyword">const</span> getTicks = <span class="function">(<span class="params">hands, timeRemaining</span>) =&gt;</span> &#123;</div><div class="line">    <span class="keyword">let</span> [hand, ...tailHands] = hands</div><div class="line">    hand.ticks = <span class="built_in">Math</span>.floor(timeRemaining / hand.ms)</div><div class="line">    <span class="keyword">return</span> tailHands.length ? [hand, ...getTicks(tailHands, timeRemaining % hand.ms)] : [hand]</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">const</span> hands = getTicks(CLOCK_HANDS, remainingTime)</div><div class="line">    .map(<span class="function">(<span class="params">hand, idx</span>) =&gt;</span> &#123;</div><div class="line">      <span class="keyword">const</span> offset = state.milliseconds &gt;= hand.ms ? <span class="number">1</span> : <span class="number">0</span></div><div class="line">      <span class="keyword">const</span> position = hand.circumference - ((hand.ticks + offset) / hand.maxTicks * hand.circumference)</div><div class="line"></div><div class="line">      <span class="keyword">return</span> &#123;</div><div class="line">        ...hand,</div><div class="line">        position</div><div class="line">      &#125;</div><div class="line">    &#125;)</div><div class="line"></div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    hands</div><div class="line">  &#125;</div><div class="line">&#125;, (&#123;</div><div class="line">  startClock,</div><div class="line">  rewindClock,</div><div class="line">  resetClock,</div><div class="line">  pauseClock</div><div class="line">&#125;))(Clock)</div></pre></td></tr></table></figure>
<hr>
<p> 现在我们需要在组件中导入新的<code>指针</code>属性.在渲染方法中给props解构赋值:</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">render () &#123;  </div><div class="line"><span class="keyword">const</span> &#123;</div><div class="line">  hands,</div><div class="line">  startClock,</div><div class="line">  rewindClock,</div><div class="line">  resetClock,</div><div class="line">  pauseClock</div><div class="line">&#125; = <span class="keyword">this</span>.props</div></pre></td></tr></table></figure>
<hr>
<p> 为了最终版本,我们做一下最终的改变.我们更新SVG,启动<code>onMouseEnter</code>,回退<code>onMouseLeave</code>,暂停<code>onClick</code>.添加一下这些变化.</p>
<p> （译者：这一段也不翻了,原作者要喝伏特加).</p>
<p>  做好了吧,现在我们在SVG内创建同心圆,遍历<code>hands</code>并且创建<code>&lt;circle&gt;</code>SVG元素,使用我们的计算值设置每个指针的半径,位置和透明度.</p>
<p>  这是最终的更新,下面是<code>render()</code>函数返回的内容：<br>  <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">   <span class="keyword">return</span> (  </div><div class="line">  &lt;svg onMouseEnter=&#123; startClock &#125; onMouseLeave=&#123; rewindClock &#125; onDoubleClick=&#123; resetClock &#125;</div><div class="line">    onClick=&#123; pauseClock &#125; className="clock" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="500"&gt;</div><div class="line">    &#123; hands.map((hand, index) =&gt; &#123;</div><div class="line">      const &#123; radius, circumference, position, alpha &#125; = hand</div><div class="line">      return (</div><div class="line">        &lt;circle key=&#123; index &#125; cx="50" cy="50" r=&#123; radius &#125; stroke=&#123; `rgba(1,1,1,$&#123;alpha&#125;)` &#125; fill="none"</div><div class="line">          strokeWidth=&#123; STROKE_WIDTH &#125; strokeDasharray=&#123; circumference &#125; strokeDashoffset=&#123; position &#125; /&gt;</div><div class="line">      )</div><div class="line">    &#125;) &#125;</div><div class="line">  &lt;/svg&gt;</div><div class="line">)</div></pre></td></tr></table></figure></p>
<hr>
<p> 忘了件事情,返回duck.js文件,从config导入MINIMUM_MS:</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> &#123; MINIMUM_MS &#125; <span class="keyword">from</span> <span class="string">'config'</span></div></pre></td></tr></table></figure>
<hr>
<p> 现在在delay函数调用时使用<code>MINIMUM_MS</code>替换<code>1000</code>.<br> 时钟每100ms就会滴答一下:</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">  <span class="function"><span class="keyword">function</span>* <span class="title">handleClockAction</span> (<span class="params">&#123; type &#125;</span>) </span>&#123;  </div><div class="line">  <span class="keyword">if</span> (type === <span class="string">'start-clock'</span>) &#123;</div><div class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</div><div class="line">      <span class="keyword">yield</span> delay(MINIMUM_MS)</div><div class="line">      <span class="keyword">yield</span> put(incrementMilliseconds())</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">'rewind-clock'</span>) &#123;</div><div class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</div><div class="line">      <span class="keyword">yield</span> delay(MINIMUM_MS)</div><div class="line">      <span class="keyword">yield</span> put(decrementMilliseconds())</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p> 看看在saga中控制流程的逻辑有多容易？</p>
<h2 id="给你的时钟上发条"><a href="#给你的时钟上发条" class="headerlink" title="给你的时钟上发条"></a>给你的时钟上发条</h2><p> 现在给这段代码拧发条,<code>npm start</code>,浏览器中打开localhost:8080.</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2044710-a754703b38f36735.gif?imageMogr2/auto-orient/strip" alt="redux-saga-clock.gif"></p>
<p> 这是一个能暂停,恢复,向前,向后和重置.看上去也很酷.</p>
<h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p> 感谢阅读这个教程,我们涉及到了js generator和Redux saga的有关内容.我希望能帮助你理解怎么使用Redux Saga,同时还有使用的好处和背后的合理性.</p>
<p> 如果你想了解更多的Redux Saga的内容,这里还有一些很好的教程.下面是我开始学习redux saga的时候帮助我入门的内容.</p>
<ul>
<li><a href="http://yelouafi.github.io/redux-saga/docs/introduction/BeginnerTutorial.html" target="_blank" rel="external">Redux的官方文档</a>是无价之宝</li>
<li><a href="http://wecodetheweb.com/2016/01/23/handling-async-in-redux-with-sagas/" target="_blank" rel="external">Niels Gerritsen’s的Redux Saga入门教程</a>.这是我最开始学习Redux saga的教程之一,结构很清晰,帮助我跨国一些概念障碍.</li>
<li><a href="http://joelhooks.com/blog/2016/03/20/build-an-image-gallery-using-redux-saga" target="_blank" rel="external">Joel Hooks的教程</a></li>
<li><a href="http://jaysoo.ca/2016/01/03/managing-processes-in-redux-using-sagas/" target="_blank" rel="external">Jack Hsu的文章</a>.我的实例实际是这个教程的扩展.</li>
</ul>
<p>我也喜欢下面的文章,解密generators,激励我写这篇文章,没有这两个文章,我都不知道generators讲的是什么玩意.</p>
<ul>
<li><a href="https://davidwalsh.name/es6-generators" target="_blank" rel="external">David Walsh的博客,关于ES6 generator的内容,作者是kyle Simpson</a></li>
<li><a href="http://www.2ality.com/2015/03/es6-generators.html2ality" target="_blank" rel="external">Axel Rauschmeyer的ES6 generators的文章</a></li>
</ul>
<p>感谢阅读!</p>

            </article>
            
                <div class="share">
                    <!--开启分享-->
<div class="share-component" data-disabled="google,twitter,facebook" data-description=""></div>

<script src="/js/share.min.js"></script>

                </div>    
            

            
            
                
                    
<div class="comments">
	<div class="ds-thread" data-thread-key="-翻译-Redux-Saga-完成时钟演示App" data-title="翻译-Redux-Saga-完成时钟演示App" data-url="http://yoursite.com/2017/03/08/-翻译-Redux-Saga-完成时钟演示App/"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"smartphp"};
		(function() {
			var ds = document.createElement('script');
			ds.type = 'text/javascript';ds.async = true;
			ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
			ds.charset = 'UTF-8';
			(document.getElementsByTagName('head')[0]
			 || document.getElementsByTagName('body')[0]).appendChild(ds);
		})();
	</script>
</div>

                
            

        </div>
        <div class="column one-fourth">
            
                
                


<h3>Post Directory</h3>

<div id="post-directory-module">
	<section class="post-directory">
		<p><strong class="toc-title">文章目录</strong></p>
		<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#实现Saga代码"><span class="toc-text">实现Saga代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#What’s-my-name-agian"><span class="toc-text">What’s my name agian?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Saga’s的方式处理异步操作"><span class="toc-text">Saga’s的方式处理异步操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#代码不要太丑陋"><span class="toc-text">代码不要太丑陋</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#完成-HIM"><span class="toc-text">完成 HIM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#给你的时钟上发条"><span class="toc-text">给你的时钟上发条</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#结束语"><span class="toc-text">结束语</span></a></li></ol>
	</section>
</div>
            
        </div>
    </div>
</section>

<footer class="container">
    <div class="site-footer" role="contentinfo">
        <div class="copyright left mobile-block">
                © 2017
                <span title="phpsmarter">phpsmarter</span>
                <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a>
        </div>

        <ul class="site-footer-links right mobile-hidden">
            <li>
                <a href="javascript:window.scrollTo(0,0)" >TOP</a>
            </li>
        </ul>

        <a href="https://phpsmarter.github.io" target="_blank" aria-label="view source code">
            <span class="mega-octicon octicon-mark-github" title="GitHub"></span>
        </a>

        <ul class="site-footer-links mobile-hidden">
            
                  
                  <li>
                    <a href="/"  title="首页">首页</a>
                  </li>
            
                  
                  <li>
                    <a href="/categories/"  title="分类">分类</a>
                  </li>
            
                  
                  <li>
                    <a href="/open-source/"  title="开源项目">开源项目</a>
                  </li>
            
                  
                  <li>
                    <a href="/message/"  title="留言板">留言板</a>
                  </li>
            
                  
                  <li>
                    <a href="/javascript/"  title="javascript">javascript</a>
                  </li>
            
            <li>
                <a href="/atom.xml">
                    <span class="octicon octicon-rss" style="color:blue;"></span>
                </a>
            </li>
        </ul>
    </div>
</footer>

		<script src="/js/geopattern.js"></script>
		<script src="/js/highlight.pack.js"></script>
		<script src="/lib/fancybox/jquery.fancybox-1.3.4.pack.js"></script>

		
			<script src="/js/toc.js"></script>
		

		

		<script src="/js/index.js"></script>

		 <script src="/js/popular_repo.js"></script> 

	</body>
</html>